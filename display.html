<!DOCTYPE html>
<html lang="es" class="h-full bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #viewer-container { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #pdf-canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #status-message { color: white; font-size: 2rem; font-family: sans-serif; text-align: center; }
        #project-id-display-display { position: absolute; bottom: 10px; left: 10px; color: rgba(255,255,255,0.2); font-family: monospace; font-size: 10px; }
        .rotate-vertical {
            transform-origin: center center;
            width: 100vh;
            height: 100vw;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%) rotate(90deg);
        }
    </style>
</head>
<body>
    <div id="viewer-container">
        <p id="status-message">Inicializando Dispositivo...</p>
        <canvas id="pdf-canvas"></canvas>
    </div>
    <div id="project-id-display-display"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwP62TA2PjU4_0epGzZHMZedQdz3Bw2ZY",
            authDomain: "tvdisplay-f1e87.firebaseapp.com",
            projectId: "tvdisplay-f1e87",
            storageBucket: "tvdisplay-f1e87.firebasestorage.app",
            messagingSenderId: "815986988801",
            appId: "1:815986988801:web:8f9ac3accc7ded14d92d00",
            measurementId: "G-TDD6C4V757"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const viewerContainer = document.getElementById('viewer-container');
        const statusMessage = document.getElementById('status-message');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const projectIdDisplay = document.getElementById('project-id-display-display');

        let pdfDoc = null;
        let currentPage = 1;
        let slideInterval = null;

        projectIdDisplay.textContent = `Project ID: ${firebaseConfig.projectId}`;

        const getDeviceNameFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            return params.get('device');
        };

        const renderPage = async (num) => {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 2.0 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            await page.render(renderContext).promise;
        };

        const startSlideshow = (durationSeconds) => {
            if (slideInterval) clearInterval(slideInterval);
            if (!pdfDoc || pdfDoc.numPages <= 1) return;

            slideInterval = setInterval(() => {
                currentPage = (currentPage % pdfDoc.numPages) + 1;
                renderPage(currentPage);
            }, durationSeconds * 1000);
        };

        const renderContent = async (contentData) => {
            console.log("=== DIRECT PDF LOAD DEBUG ===");
            console.log("contentData received:", contentData);
            
            if (!contentData?.downloadURL) {
                statusMessage.textContent = 'Contenido no asignado.';
                canvas.style.display = 'none';
                return;
            }

            statusMessage.textContent = 'Cargando PDF...';
            canvas.style.display = 'none';
            if (slideInterval) clearInterval(slideInterval);
            
            if (contentData.orientation === 'vertical') {
                viewerContainer.classList.add('rotate-vertical');
            } else {
                viewerContainer.classList.remove('rotate-vertical');
            }

            try {
                console.log("Loading PDF directly from URL:", contentData.downloadURL);
                const loadingTask = pdfjsLib.getDocument(contentData.downloadURL);
                pdfDoc = await loadingTask.promise;
                
                console.log("PDF loaded successfully, pages:", pdfDoc.numPages);
                statusMessage.textContent = '';
                canvas.style.display = 'block';
                currentPage = 1;
                await renderPage(currentPage);
                startSlideshow(contentData.slideDuration || 10);

            } catch (error) {
                console.error("Error loading PDF:", error);
                statusMessage.textContent = 'Error al cargar el PDF.';
            }
        };

        const listenForDeviceChanges = (deviceName) => {
            statusMessage.textContent = `Buscando "${deviceName}"...`;
            const deviceRef = doc(db, 'devices', deviceName.toUpperCase());

            onSnapshot(deviceRef, (deviceSnap) => {
                if (!deviceSnap.exists()) {
                    statusMessage.textContent = `Dispositivo "${deviceName}" no encontrado.`;
                    return;
                }
                
                const deviceData = deviceSnap.data();
                const contentId = deviceData.assignedContent;

                if (!contentId) {
                    statusMessage.textContent = 'Dispositivo en espera.';
                    if (slideInterval) clearInterval(slideInterval);
                    canvas.style.display = 'none';
                    return;
                }

                const contentRef = doc(db, 'content', contentId);
                onSnapshot(contentRef, (contentSnap) => {
                    if (contentSnap.exists()) {
                        renderContent(contentSnap.data());
                    } else {
                        statusMessage.textContent = 'Contenido no encontrado.';
                    }
                });
            });
        };

        const deviceName = getDeviceNameFromURL();
        if (deviceName) {
            listenForDeviceChanges(deviceName);
        } else {
            statusMessage.textContent = 'Error: Dispositivo no especificado.';
        }
    </script>
</body>
</html>