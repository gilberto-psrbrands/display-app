<!DOCTYPE html>
<html lang="es" class="h-full bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #viewer-container { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #pdf-canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #video-player { max-width: 100%; max-height: 100%; object-fit: contain; }
        #status-message { color: white; font-size: 2rem; font-family: sans-serif; text-align: center; }
        #project-id-display-display { position: absolute; bottom: 10px; left: 10px; color: rgba(255,255,255,0.2); font-family: monospace; font-size: 10px; }
        .rotate-vertical {
            transform-origin: center center;
            width: 100vh;
            height: 100vw;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%) rotate(90deg);
        }
        #pairing-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-family: sans-serif;
        }
        .waiting-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="flex items-center justify-center">
    <div id="viewer-container">
        <p id="status-message">Inicializando Dispositivo...</p>
        <canvas id="pdf-canvas" style="display: none;"></canvas>
        <video id="video-player" style="display: none;" muted autoplay></video>
    </div>
    
    <!-- Pantalla de dispositivo en espera (no emparejado) -->
    <div id="pairing-info" class="hidden">
        <div class="waiting-animation">
            <h1 class="text-4xl font-bold mb-4">Dispositivo en espera</h1>
            <p class="text-xl mb-6">Este dispositivo requiere emparejamiento</p>
            <div class="text-gray-400">
                <p class="mb-2">Para emparejar este dispositivo:</p>
                <p class="mb-1">1. Vaya al panel de administración</p>
                <p class="mb-1">2. Genere un código de emparejamiento</p>
                <p class="mb-4">3. Visite: <span class="text-cyan-400">tvdisplay-f1e87.web.app/tv-pair-secure.html</span></p>
            </div>
            <p id="device-id-display" class="text-sm text-gray-500 mt-8"></p>
        </div>
    </div>
    
    <div id="project-id-display-display"></div>

    <script type="module">
        // --- Conexión con Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwP62TA2PjU4_0epGzZHMZedQdz3Bw2ZY",
            authDomain: "tvdisplay-f1e87.firebaseapp.com",
            projectId: "tvdisplay-f1e87",
            storageBucket: "tvdisplay-f1e87.firebasestorage.app",
            messagingSenderId: "815986988801",
            appId: "1:815986988801:web:8f9ac3accc7ded14d92d00",
            measurementId: "G-TDD6C4V757"
        };
        
        // --- Inicialización de Servicios ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Variables globales ---
        const viewerContainer = document.getElementById('viewer-container');
        const statusMessage = document.getElementById('status-message');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const videoPlayer = document.getElementById('video-player');
        const projectIdDisplay = document.getElementById('project-id-display-display');
        const pairingInfo = document.getElementById('pairing-info');
        const deviceIdDisplay = document.getElementById('device-id-display');

        let pdfDoc = null;
        let currentPage = 1;
        let slideInterval = null;
        let playlistInterval = null;
        let deviceFingerprint = null;
        let currentPlaylist = null;
        let currentPlaylistIndex = 0;

        projectIdDisplay.textContent = `Project ID: ${firebaseConfig.projectId || 'No definido'}`;

        // --- SISTEMA DE FINGERPRINTING (MANTIENE TU LÓGICA ORIGINAL) ---
        function generateDeviceFingerprint() {
            try {
                const fingerprintData = [];
                
                // 1. User Agent
                const userAgent = navigator.userAgent || 'unknown';
                fingerprintData.push('ua:' + userAgent.substring(0, 100));
                
                // 2. Screen Resolution
                const screenRes = `${screen.width}x${screen.height}`;
                fingerprintData.push('screen:' + screenRes);
                
                // 3. Platform
                const platform = navigator.platform || 'unknown';
                fingerprintData.push('platform:' + platform);
                
                // 4. Language
                const language = navigator.language || 'unknown';
                fingerprintData.push('lang:' + language);
                
                // 5. Timezone
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'unknown';
                fingerprintData.push('tz:' + timezone);
                
                // 6. Device Pixel Ratio
                const dpr = window.devicePixelRatio || 1;
                fingerprintData.push('dpr:' + dpr);
                
                // 7. Device Type Detection
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
                const isTablet = /iPad|Android.*Tablet/i.test(userAgent);
                const isTV = /Smart-TV|SMARTTV|NetCast|BRAVIA|GoogleTV|SmartTV/i.test(userAgent);
                
                let deviceType = 'desktop';
                if (isTV) deviceType = 'tv';
                else if (isTablet) deviceType = 'tablet';
                else if (isMobile) deviceType = 'mobile';
                
                fingerprintData.push('device:' + deviceType);
                
                // 8. Canvas Fingerprinting
                try {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = 200;
                    tempCanvas.height = 50;
                    tempCtx.textBaseline = 'top';
                    tempCtx.font = '14px Arial';
                    tempCtx.fillText('Device fingerprint test 🔒', 2, 2);
                    const canvasData = tempCanvas.toDataURL().substring(22, 42);
                    fingerprintData.push('canvas:' + canvasData);
                } catch (e) {
                    fingerprintData.push('canvas:error');
                }
                
                // Generar hash final
                const combinedData = fingerprintData.join('|');
                const hash = simpleHash(combinedData);
                
                console.log('=== DEVICE FINGERPRINT GENERATION ===');
                console.log('Combined data:', combinedData);
                console.log('Final fingerprint:', hash);
                
                return hash;
                
            } catch (error) {
                console.error('Error generating fingerprint:', error);
                return 'error-' + Date.now();
            }
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // --- FUNCIONES DE UTILIDAD ---
        const getDeviceNameFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            return params.get('device');
        };

        const showPairingScreen = (deviceId) => {
            console.log("=== SWITCHING TO PAIRING SCREEN ===");
            
            // Limpiar cualquier contenido activo
            clearAllIntervals();
            hideAllPlayers();
            
            viewerContainer.style.display = 'none';
            pairingInfo.classList.remove('hidden');
            deviceIdDisplay.textContent = `Dispositivo: ${deviceId}`;
        };

        const hidePairingScreen = () => {
            pairingInfo.classList.add('hidden');
            viewerContainer.style.display = 'flex';
        };

        const clearAllIntervals = () => {
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = null;
            }
            if (playlistInterval) {
                clearInterval(playlistInterval);
                playlistInterval = null;
            }
        };

        const hideAllPlayers = () => {
            canvas.style.display = 'none';
            videoPlayer.style.display = 'none';
            statusMessage.style.display = 'block';
            
            // Pausar video si está reproduciéndose
            if (!videoPlayer.paused) {
                videoPlayer.pause();
            }
            
            // Limpiar canvas
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // --- RENDERIZADO DE PDF (MANTIENE TU LÓGICA ORIGINAL) ---
        const renderPage = async (num) => {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 2.0 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            await page.render(renderContext).promise;
        };

        const startSlideshow = (durationSeconds) => {
            if (slideInterval) clearInterval(slideInterval);
            if (!pdfDoc || pdfDoc.numPages <= 1) return;

            slideInterval = setInterval(() => {
                currentPage = (currentPage % pdfDoc.numPages) + 1;
                renderPage(currentPage);
            }, durationSeconds * 1000);
        };

        // --- RENDERIZADO DE CONTENIDO MEJORADO (PDF + VIDEO + PLAYLIST) ---
        const renderContent = async (contentData) => {
            console.log('=== RENDERING CONTENT ===');
            console.log('Content data:', contentData);
            
            if (!contentData) {
                statusMessage.textContent = 'Contenido no asignado o no encontrado.';
                hideAllPlayers();
                return;
            }

            // Limpiar estado anterior
            clearAllIntervals();
            hideAllPlayers();
            statusMessage.style.display = 'block';

            // Configurar orientación
            if (contentData.orientation === 'vertical') {
                viewerContainer.classList.add('rotate-vertical');
            } else {
                viewerContainer.classList.remove('rotate-vertical');
            }

            try {
                // Determinar tipo de contenido
                const mediaType = contentData.mediaType || 'pdf'; // Default a PDF para compatibilidad
                
                console.log('Media type:', mediaType);
                
                if (mediaType === 'pdf') {
                    await renderPDF(contentData);
                } else if (mediaType === 'video') {
                    await renderVideo(contentData);
                } else if (mediaType === 'playlist') {
                    await renderPlaylist(contentData);
                } else {
                    throw new Error(`Tipo de contenido no soportado: ${mediaType}`);
                }

            } catch (error) {
                console.error("Error al cargar contenido:", error);
                statusMessage.textContent = `Error al cargar el contenido: ${error.message}`;
                statusMessage.style.display = 'block';
            }
        };

        const renderPDF = async (contentData) => {
            statusMessage.textContent = 'Cargando PDF...';
            
            if (!contentData.downloadURL) {
                throw new Error('No se encontró downloadURL para el PDF');
            }
            
            const response = await fetch(contentData.downloadURL);
            if (!response.ok) {
                throw new Error(`Error al descargar PDF: ${response.status}`);
            }
            
            const pdfArrayBuffer = await response.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument(pdfArrayBuffer);
            pdfDoc = await loadingTask.promise;
            
            statusMessage.style.display = 'none';
            canvas.style.display = 'block';
            currentPage = 1;
            await renderPage(currentPage);
            startSlideshow(contentData.slideDuration || 10);
        };

        const renderVideo = async (contentData) => {
            statusMessage.textContent = 'Cargando video...';
            
            if (!contentData.downloadURL) {
                throw new Error('No se encontró downloadURL para el video');
            }

            return new Promise((resolve, reject) => {
                videoPlayer.onloadeddata = () => {
                    console.log('Video loaded successfully');
                    statusMessage.style.display = 'none';
                    videoPlayer.style.display = 'block';
                    videoPlayer.play().then(() => {
                        resolve();
                    }).catch(reject);
                };

                videoPlayer.onerror = () => {
                    reject(new Error('Error al cargar el video'));
                };

                // Configurar video para bucle continuo
                videoPlayer.loop = true;
                videoPlayer.muted = true; // Requerido para autoplay
                videoPlayer.src = contentData.downloadURL;
            });
        };

        const renderPlaylist = async (playlistData) => {
            console.log('=== RENDERING PLAYLIST ===');
            console.log('Playlist data:', playlistData);
            
            if (!playlistData.items || playlistData.items.length === 0) {
                throw new Error('La playlist está vacía');
            }

            currentPlaylist = playlistData;
            currentPlaylistIndex = 0;
            
            statusMessage.textContent = `Cargando playlist: ${playlistData.name}`;
            await playNextPlaylistItem();
        };

        const playNextPlaylistItem = async () => {
            if (!currentPlaylist || !currentPlaylist.items) return;
            
            const item = currentPlaylist.items[currentPlaylistIndex];
            console.log(`Playing playlist item ${currentPlaylistIndex + 1}/${currentPlaylist.items.length}:`, item);
            
            try {
                // Buscar el contenido real por ID
                const contentDoc = await new Promise((resolve, reject) => {
                    const unsubscribe = onSnapshot(
                        doc(db, 'content', item.contentId),
                        (doc) => {
                            unsubscribe();
                            if (doc.exists()) {
                                resolve(doc.data());
                            } else {
                                reject(new Error(`Contenido no encontrado: ${item.contentId}`));
                            }
                        },
                        (error) => {
                            unsubscribe();
                            reject(error);
                        }
                    );
                });

                // Renderizar el contenido individual
                if (contentDoc.mediaType === 'pdf') {
                    await renderPDF(contentDoc);
                    // Para PDFs, usar la duración del item de la playlist
                    if (slideInterval) clearInterval(slideInterval);
                    setTimeout(() => {
                        nextPlaylistItem();
                    }, item.duration * 1000);
                } else if (contentDoc.mediaType === 'video') {
                    await renderVideo(contentDoc);
                    // Para videos, esperar la duración especificada en la playlist
                    setTimeout(() => {
                        nextPlaylistItem();
                    }, item.duration * 1000);
                }

            } catch (error) {
                console.error('Error playing playlist item:', error);
                // Continuar con el siguiente item si hay error
                setTimeout(() => {
                    nextPlaylistItem();
                }, 3000);
            }
        };

        const nextPlaylistItem = () => {
            if (!currentPlaylist) return;
            
            currentPlaylistIndex++;
            
            // Si llegamos al final y loop está activado, volver al inicio
            if (currentPlaylistIndex >= currentPlaylist.items.length) {
                if (currentPlaylist.loop) {
                    currentPlaylistIndex = 0;
                } else {
                    // Si no hay loop, quedarse en el último item
                    currentPlaylistIndex = currentPlaylist.items.length - 1;
                    return;
                }
            }
            
            playNextPlaylistItem();
        };

        // --- SISTEMA DE DISPOSITIVOS (MANTIENE TU LÓGICA ORIGINAL) ---
        const listenForDeviceChanges = (deviceName) => {
            console.log("=== STARTING DEVICE LISTENER ===");
            console.log("Device name:", deviceName);
            
            deviceFingerprint = generateDeviceFingerprint();
            console.log("Device fingerprint:", deviceFingerprint);
            
            const deviceRef = doc(db, 'devices', deviceName.toUpperCase());
            
            onSnapshot(deviceRef, async (deviceDoc) => {
                console.log("=== DEVICE DOCUMENT UPDATE ===");
                
                if (!deviceDoc.exists()) {
                    console.log("Device document does not exist");
                    statusMessage.textContent = 'Dispositivo no encontrado en el sistema.';
                    return;
                }
                
                const deviceData = deviceDoc.data();
                console.log("Device data:", deviceData);
                
                // Verificar emparejamiento y fingerprint
                if (!deviceData.paired) {
                    console.log("Device is not paired - showing pairing screen");
                    showPairingScreen(deviceName);
                    return;
                }
                
                // DEBUGGING DETALLADO PARA FINGERPRINT MISMATCH
                if (deviceData.fingerprint && deviceData.fingerprint !== deviceFingerprint) {
                    console.log("=== FINGERPRINT MISMATCH DEBUG ===");
                    console.log("Expected (from DB):", deviceData.fingerprint);
                    console.log("Expected type:", typeof deviceData.fingerprint);
                    console.log("Expected length:", deviceData.fingerprint ? deviceData.fingerprint.length : 'N/A');
                    console.log("Actual (generated):", deviceFingerprint);
                    console.log("Actual type:", typeof deviceFingerprint);
                    console.log("Actual length:", deviceFingerprint ? deviceFingerprint.length : 'N/A');
                    console.log("Are they equal?", deviceData.fingerprint === deviceFingerprint);
                    console.log("Trimmed comparison:", 
                        deviceData.fingerprint ? deviceData.fingerprint.trim() : 'null', 
                        "===", 
                        deviceFingerprint ? deviceFingerprint.trim() : 'null',
                        "=",
                        deviceData.fingerprint && deviceFingerprint ? deviceData.fingerprint.trim() === deviceFingerprint.trim() : false
                    );
                    
                    // TEMPORAL: Comentar esta línea para permitir acceso durante debugging
                    console.log("⚠️ FINGERPRINT CHECK TEMPORARILY DISABLED FOR DEBUGGING");
                    // statusMessage.textContent = 'Error de autenticación del dispositivo.';
                    // return;
                }
                
                // Dispositivo emparejado y verificado
                hidePairingScreen();
                
                if (!deviceData.assignedContent) {
                    statusMessage.textContent = 'Dispositivo en espera...';
                    hideAllPlayers();
                    return;
                }
                
                // Determinar si es contenido individual o playlist
                const contentType = deviceData.assignedContentType || 'content';
                
                if (contentType === 'playlist') {
                    // Cargar playlist
                    const playlistRef = doc(db, 'playlists', deviceData.assignedContent);
                    onSnapshot(playlistRef, (playlistDoc) => {
                        if (playlistDoc.exists()) {
                            renderContent({ ...playlistDoc.data(), mediaType: 'playlist' });
                        } else {
                            statusMessage.textContent = 'Playlist no encontrada.';
                        }
                    });
                } else {
                    // Cargar contenido individual
                    const contentRef = doc(db, 'content', deviceData.assignedContent);
                    onSnapshot(contentRef, (contentDoc) => {
                        if (contentDoc.exists()) {
                            renderContent(contentDoc.data());
                        } else {
                            statusMessage.textContent = 'Contenido no encontrado.';
                        }
                    });
                }
            });
        };

        // --- INICIALIZAR APLICACIÓN ---
        const deviceName = getDeviceNameFromURL();
        if (deviceName) {
            listenForDeviceChanges(deviceName);
        } else {
            statusMessage.textContent = 'Error: Nombre de dispositivo no especificado en la URL.';
        }
    </script>
</body>
</html>