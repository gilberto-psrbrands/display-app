<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVDisplay - Centro de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="h-full flex items-center justify-center text-white">
    <!-- Pantalla de Login -->
    <div id="login-screen" class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg" style="display: none;">
        <div class="text-center">
            <h2 class="text-2xl font-bold">Admin Login</h2>
        </div>
        <form id="login-form" class="space-y-6">
            <div>
                <label for="email" class="text-sm font-medium">Email</label>
                <input type="email" id="email" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-400">
            </div>
            <div>
                <label for="password" class="text-sm font-medium">Password</label>
                <input type="password" id="password" required class="w-full px-4 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-400">
            </div>
            <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-cyan-600 rounded-md hover:bg-cyan-700 transition">Sign In</button>
            <p id="login-error" class="text-sm text-red-500 text-center"></p>
        </form>
    </div>

    <!-- Panel de Administración -->
    <div id="admin-panel" class="w-full h-full p-6 bg-gray-900" style="display: none;">
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <div>
                <h1 class="text-2xl font-bold text-cyan-400">Broadcast Control Panel</h1>
                <p id="project-id-display-admin" class="text-xs text-gray-500 font-mono"></p>
            </div>
            <div class="flex items-center space-x-4">
                <span id="user-email" class="text-sm text-gray-400"></span>
                <button id="logout-button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">Logout</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 1. Subir Nuevo Contenido -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">1. Subir Nuevo Contenido</h3>
                <form id="upload-form" class="space-y-4">
                    <input type="text" id="content-name" placeholder="Nombre del Contenido (ej. Anuncio Q3)" required class="w-full px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                    <select id="content-level" class="w-full px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                        <option value="Content-Publico">Content-Publico (Todos los dispositivos)</option>
                        <option value="Content-Management">Content-Management (Dispositivos Management y Privado)</option>
                        <option value="Content-Privado">Content-Privado (Solo dispositivos Privado)</option>
                    </select>
                    <select id="orientation" class="w-full px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                        <option value="horizontal">Horizontal</option>
                        <option value="vertical">Vertical</option>
                    </select>
                    <input type="number" id="slide-duration" placeholder="Duración de Diapositiva (segundos)" required value="10" class="w-full px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                    <input type="file" id="pdf-file" accept=".pdf" required class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-cyan-600 rounded-md hover:bg-cyan-700 transition">Subir Contenido</button>
                    <p id="upload-status" class="text-sm text-center"></p>
                </form>
            </div>

            <!-- 2. Administrar Dispositivos -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">2. Administrar Dispositivos</h3>
                <form id="add-device-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="device-name" placeholder="Nombre (ej. TV Lobby)" required class="w-full px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                    <select id="device-level" class="px-3 py-2 text-gray-900 bg-gray-300 rounded-md">
                        <option value="Display-Planta">Display-Planta</option>
                        <option value="Display-Management">Display-Management</option>
                        <option value="Display-Privado">Display-Privado</option>
                    </select>
                    <button type="submit" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition">Añadir</button>
                </form>
                <p id="device-status" class="text-sm text-center mb-2"></p>
                <p id="assignment-status" class="text-sm text-center mb-2 text-blue-400"></p>
                <div id="devices-list" class="space-y-3"></div>
            </div>

            <!-- 3. Librería de Contenido -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">3. Librería de Contenido</h3>
                <div id="content-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Conexión con Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwP62TA2PjU4_0epGzZHMZedQdz3Bw2ZY",
            authDomain: "tvdisplay-f1e87.firebaseapp.com",
            projectId: "tvdisplay-f1e87",
            storageBucket: "tvdisplay-f1e87.firebasestorage.app",
            messagingSenderId: "815986988801",
            appId: "1:815986988801:web:8f9ac3accc7ded14d92d00",
            measurementId: "G-TDD6C4V757"
        };
        
        // --- Inicialización de Servicios ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Elementos del DOM ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const userEmailDisplay = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        const addDeviceForm = document.getElementById('add-device-form');
        const deviceStatus = document.getElementById('device-status');
        const assignmentStatus = document.getElementById('assignment-status');
        const devicesList = document.getElementById('devices-list');
        const contentList = document.getElementById('content-list');
        const projectIdDisplayAdmin = document.getElementById('project-id-display-admin');
        
        // Modal para códigos de emparejamiento
        let pairingModal = null;

        // Crear modal dinámicamente
        function createPairingModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
            modal.id = 'pairing-modal';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-cyan-400 mb-4">Código de Emparejamiento</h3>
                        <div class="bg-gray-900 p-6 rounded-lg mb-4">
                            <p class="text-gray-300 text-sm mb-2">Código para dispositivo:</p>
                            <p id="modal-device-name" class="text-lg font-semibold text-white mb-4"></p>
                            <div class="bg-black p-4 rounded border-2 border-cyan-400">
                                <p id="modal-pairing-code" class="text-3xl font-mono font-bold text-cyan-400 tracking-widest text-center"></p>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Válido por <span id="modal-expiry-time">15 minutos</span></p>
                        </div>
                        <div class="text-xs text-gray-400 mb-4">
                            <p>1. Vaya al dispositivo y navegue a:</p>
                            <p class="font-mono text-cyan-300">tvdisplay-f1e87.web.app/tv-pair.html</p>
                            <p>2. Ingrese el código mostrado arriba</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="copy-code-btn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                                Copiar Código
                            </button>
                            <button id="close-modal-btn" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        projectIdDisplayAdmin.textContent = `Project ID: ${firebaseConfig.projectId || 'No definido'}`;

        let availableContent = [];

        // Función para generar código de emparejamiento
        function generatePairingCode() {
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ0123456789'; // Sin O para evitar confusión con 0
            let code = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) code += '-';
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Función para mostrar modal de código de emparejamiento
        async function showPairingModal(deviceId, deviceName) {
            if (!pairingModal) {
                pairingModal = createPairingModal();
                
                // Event listeners para el modal
                document.getElementById('copy-code-btn').addEventListener('click', () => {
                    const code = document.getElementById('modal-pairing-code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        const btn = document.getElementById('copy-code-btn');
                        const originalText = btn.textContent;
                        btn.textContent = '¡Copiado!';
                        btn.className = btn.className.replace('bg-green-600', 'bg-blue-600');
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.className = btn.className.replace('bg-blue-600', 'bg-green-600');
                        }, 2000);
                    });
                });
                
                document.getElementById('close-modal-btn').addEventListener('click', () => {
                    pairingModal.classList.add('hidden');
                });
                
                // Cerrar con click en fondo
                pairingModal.addEventListener('click', (e) => {
                    if (e.target === pairingModal) {
                        pairingModal.classList.add('hidden');
                    }
                });
            }

            try {
                // Generar código único
                const pairingCode = generatePairingCode();
                const expiryTime = new Date(Date.now() + 15 * 60 * 1000); // 15 minutos

                // Guardar código en Firebase
                await setDoc(doc(db, 'pairing_codes', pairingCode), {
                    deviceId: deviceId,
                    deviceName: deviceName,
                    createdAt: serverTimestamp(),
                    expiresAt: expiryTime,
                    used: false,
                    generatedBy: auth.currentUser?.email || 'admin'
                });

                // Mostrar en modal
                document.getElementById('modal-device-name').textContent = deviceName;
                document.getElementById('modal-pairing-code').textContent = pairingCode;
                document.getElementById('modal-expiry-time').textContent = '15 minutos';
                
                pairingModal.classList.remove('hidden');

                deviceStatus.textContent = `Código generado para ${deviceName}: ${pairingCode}`;
                
            } catch (error) {
                console.error('Error generating pairing code:', error);
                deviceStatus.textContent = `Error al generar código: ${error.message}`;
            }
        }

        // Función para desemparejar dispositivo
        async function unpairDevice(deviceId, deviceName) {
            if (!confirm(`¿Está seguro que desea desemparejar el dispositivo "${deviceName}"?\n\nEsto bloqueará el acceso al contenido hasta que se vuelva a emparejar.`)) {
                return;
            }

            try {
                // Actualizar dispositivo como no emparejado
                const deviceRef = doc(db, 'devices', deviceId);
                await setDoc(deviceRef, {
                    paired: false,
                    pairingCode: null,
                    unpairedAt: serverTimestamp(),
                    unpairedBy: auth.currentUser?.email || 'admin'
                }, { merge: true });

                deviceStatus.textContent = `Dispositivo ${deviceName} desemparejado exitosamente`;
                
            } catch (error) {
                console.error('Error unpairing device:', error);
                deviceStatus.textContent = `Error al desemparejar: ${error.message}`;
            }
        }

        // Control de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                adminPanel.style.display = 'block';
                userEmailDisplay.textContent = user.email;
                loadInitialData();
            } else {
                loginScreen.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = error.message;
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // Subir contenido
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const contentName = document.getElementById('content-name').value.trim().toUpperCase();
            const contentLevel = document.getElementById('content-level').value;
            const orientation = document.getElementById('orientation').value;
            const slideDuration = document.getElementById('slide-duration').value;
            const pdfFile = document.getElementById('pdf-file').files[0];
            
            if (!contentName || !pdfFile) {
                uploadStatus.textContent = "Nombre y archivo son requeridos.";
                return;
            }
            uploadStatus.textContent = 'Subiendo archivo...';

            try {
                const filePath = `pdfs/${Date.now()}_${pdfFile.name}`;
                const storageRef = ref(storage, filePath);
                const snapshot = await uploadBytes(storageRef, pdfFile);
                const downloadURL = await getDownloadURL(snapshot.ref);

                await setDoc(doc(db, 'content', contentName), {
                    name: contentName,
                    contentLevel: contentLevel,
                    orientation: orientation,
                    slideDuration: parseInt(slideDuration, 10),
                    filePath: filePath,
                    downloadURL: downloadURL
                });

                uploadStatus.textContent = `¡Contenido "${contentName}" subido exitosamente!`;
                uploadForm.reset();
            } catch (error) {
                console.error("Upload Error:", error);
                uploadStatus.textContent = `Error al subir: ${error.message}`;
            }
        });

        // Añadir dispositivo
        addDeviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const deviceNameInput = document.getElementById('device-name');
            const deviceLevel = document.getElementById('device-level').value;
            const deviceName = deviceNameInput.value.trim().toUpperCase();
            if (!deviceName) return;
            try {
                await setDoc(doc(db, 'devices', deviceName), {
                    name: deviceName,
                    deviceLevel: deviceLevel.replace('Display-', ''), // Guarda solo "Planta", "Management", "Privado"
                    assignedContent: null,
                    paired: false // Campo para control de emparejamiento
                });
                deviceStatus.textContent = `¡Dispositivo "${deviceName}" añadido!`;
                addDeviceForm.reset();
            } catch(error) {
                console.error("Add device error:", error);
                deviceStatus.textContent = `Error: ${error.message}`;
            }
        });

        const renderDevices = (devices) => {
            devicesList.innerHTML = '';
            devices.forEach(device => {
                const deviceEl = document.createElement('div');
                deviceEl.className = 'bg-gray-700 p-3 rounded-md';
                
                // Filtrar contenido según el nivel del dispositivo
                const deviceLevel = device.deviceLevel || 'Planta';
                const compatibleContent = availableContent.filter(c => {
                    const contentLevel = c.contentLevel || 'Content-Publico';
                    
                    if (deviceLevel === 'Privado') {
                        return true; // Privado puede ver todo
                    } else if (deviceLevel === 'Management') {
                        return contentLevel === 'Content-Publico' || contentLevel === 'Content-Management';
                    } else { // deviceLevel === 'Planta'
                        return contentLevel === 'Content-Publico';
                    }
                });
                
                const optionsHtml = compatibleContent.map(c => 
                    `<option value="${c.id}" ${device.assignedContent === c.id ? 'selected' : ''}>${c.name}</option>`
                ).join('');
                
                const levelBadge = (() => {
                    switch(deviceLevel) {
                        case 'Privado': return '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded font-semibold">PRIVADO</span>';
                        case 'Management': return '<span class="bg-yellow-500 text-black text-xs px-2 py-1 rounded font-semibold">MANAGEMENT</span>';
                        default: return '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded font-semibold">PLANTA</span>';
                    }
                })();

                const pairedStatus = device.paired ? 
                    '<span class="bg-green-600 text-white text-xs px-2 py-1 rounded font-semibold ml-2">EMPAREJADO</span>' :
                    '<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded font-semibold ml-2">SIN EMPAREJAR</span>';
                
                deviceEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold">${device.name}</span>
                            ${levelBadge}
                            ${pairedStatus}
                        </div>
                        <button data-device-id="${device.id}" class="delete-device-btn text-red-500 hover:text-red-400">×</button>
                    </div>
                    <div class="space-y-2">
                        <select data-device-id="${device.id}" class="assign-content-select w-full px-2 py-1 text-gray-900 bg-gray-300 rounded-md">
                            <option value="">-- Sin Asignar --</option>
                            ${optionsHtml}
                        </select>
                        ${device.paired ? 
                            `<button 
                                data-device-id="${device.id}" 
                                data-device-name="${device.name}"
                                class="unpair-device-btn w-full px-3 py-1 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition"
                            >
                                Desemparejar Dispositivo
                            </button>` :
                            `<button 
                                data-device-id="${device.id}" 
                                data-device-name="${device.name}"
                                class="generate-pairing-btn w-full px-3 py-1 text-sm font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700 transition"
                            >
                                Generar Código de Emparejamiento
                            </button>`
                        }
                    </div>
                `;
                devicesList.appendChild(deviceEl);
            });
        };

        const renderContentList = (content) => {
            contentList.innerHTML = '';
            content.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-gray-700 p-3 rounded-md flex justify-between items-center';
                
                const levelBadge = (() => {
                    const contentLevel = item.contentLevel || 'Content-Publico';
                    switch(contentLevel) {
                        case 'Content-Privado': return '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded font-semibold">PRIVADO</span>';
                        case 'Content-Management': return '<span class="bg-yellow-500 text-black text-xs px-2 py-1 rounded font-semibold">MANAGEMENT</span>';
                        default: return '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded font-semibold">PUBLICO</span>';
                    }
                })();
                
                itemEl.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <p class="font-semibold">${item.name}</p>
                            ${levelBadge}
                        </div>
                        <p class="text-xs text-gray-400">${item.orientation}</p>
                    </div>
                    <button data-content-id="${item.id}" class="delete-content-btn text-red-500 hover:text-red-400">×</button>
                `;
                contentList.appendChild(itemEl);
            });
        };
        
        // Cargar y mostrar datos en tiempo real
        const loadInitialData = () => {
            // Cargar contenido
            onSnapshot(collection(db, 'content'), (snapshot) => {
                availableContent = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContentList(availableContent);
                
                // Cargar dispositivos después de que el contenido esté listo
                onSnapshot(collection(db, 'devices'), (snapshot) => {
                    const devices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDevices(devices);
                });
            });
        };

        // EVENTO CORREGIDO: Delegación de eventos para asignación de contenido
        devicesList.addEventListener('change', async (e) => {
            if (e.target.classList.contains('assign-content-select')) {
                const deviceId = e.target.dataset.deviceId;
                const contentId = e.target.value || null;
                
                console.log('Assigning content:', { deviceId, contentId });
                assignmentStatus.textContent = `Asignando contenido a ${deviceId}...`;
                
                try {
                    // CORRECCIÓN: Usar setDoc con merge para asegurar que funcione
                    const deviceRef = doc(db, 'devices', deviceId);
                    await setDoc(deviceRef, {
                        assignedContent: contentId
                    }, { merge: true });
                    
                    assignmentStatus.textContent = `¡Contenido asignado exitosamente a ${deviceId}!`;
                    console.log('Content assigned successfully');
                    
                    // Limpiar el mensaje después de 3 segundos
                    setTimeout(() => {
                        assignmentStatus.textContent = '';
                    }, 3000);
                    
                } catch (error) {
                    console.error("Error assigning content:", error);
                    assignmentStatus.textContent = `Error al asignar contenido: ${error.message}`;
                    
                    // Mostrar el error también en device-status
                    deviceStatus.textContent = `Error crítico: ${error.message}`;
                }
            }
        });

        // Eliminar dispositivo, generar códigos y desemparejar
        devicesList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-device-btn')) {
                const deviceId = e.target.dataset.deviceId;
                if (confirm(`¿Seguro que quieres eliminar el dispositivo "${deviceId}"?`)) {
                    try {
                        await deleteDoc(doc(db, 'devices', deviceId));
                        deviceStatus.textContent = `Dispositivo ${deviceId} eliminado.`;
                    } catch (error) {
                        console.error("Delete device error:", error);
                        deviceStatus.textContent = `Error al eliminar: ${error.message}`;
                    }
                }
            } else if (e.target.classList.contains('generate-pairing-btn')) {
                const deviceId = e.target.dataset.deviceId;
                const deviceName = e.target.dataset.deviceName;
                await showPairingModal(deviceId, deviceName);
            } else if (e.target.classList.contains('unpair-device-btn')) {
                const deviceId = e.target.dataset.deviceId;
                const deviceName = e.target.dataset.deviceName;
                await unpairDevice(deviceId, deviceName);
            }
        });

        // Eliminar contenido
        contentList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-content-btn')) {
                const contentId = e.target.dataset.contentId;
                if (confirm(`¿Seguro que quieres eliminar el contenido "${contentId}"?`)) {
                    try {
                        await deleteDoc(doc(db, 'content', contentId));
                        // TODO: También eliminar el archivo de Storage
                    } catch (error) {
                        console.error("Delete content error:", error);
                    }
                }
            }
        });
    </script>
</body>
</html>